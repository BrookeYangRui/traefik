# Traefik å®é™…éƒ¨ç½²é…ç½®åˆ†æ

## ç›®æ ‡
åˆ†æå®é™…åº”ç”¨ä¸­å¼€å‘è€…å¦‚ä½•é…ç½® Traefikï¼Œç‰¹åˆ«æ˜¯æ˜¯å¦ä½¿ç”¨äº†ä¸å®‰å…¨çš„é…ç½®é€‰é¡¹ã€‚

---

## å…³é”®å‘ç°

### 1. é»˜è®¤é…ç½®è¡Œä¸º

**é‡è¦å‘ç°ï¼š**
- `forwardedHeaders.insecure` çš„**é»˜è®¤å€¼æ˜¯ `false`**
- `trustForwardHeader` çš„**é»˜è®¤å€¼æ˜¯ `false`**
- è¿™æ„å‘³ç€**é»˜è®¤æƒ…å†µä¸‹æ˜¯å®‰å…¨çš„**

**ä»£ç è¯æ®ï¼š**
```go
// pkg/config/static/entrypoints.go:176
type ForwardedHeaders struct {
    Insecure bool `description:"Trust all forwarded headers." json:"insecure,omitempty" ...`
    // é»˜è®¤å€¼ä¸º false
}
```

### 2. æ–‡æ¡£ä¸­çš„é…ç½®ç¤ºä¾‹

#### ç¤ºä¾‹ 1: åŸºç¡€ Docker Compose ç¤ºä¾‹

**æ–‡ä»¶ï¼š** `docs/content/user-guides/docker-compose/basic-example/docker-compose.yml`

```yaml
services:
  traefik:
    image: "traefik:v3.6"
    command:
      - "--api.insecure=true"  # âš ï¸ ä»…ç”¨äºå¼€å‘
      - "--providers.docker=true"
      - "--entryPoints.web.address=:80"
```

**åˆ†æï¼š**
- âœ… **æ²¡æœ‰è®¾ç½®** `forwardedHeaders.insecure`
- âœ… **æ²¡æœ‰è®¾ç½®** `trustForwardHeader`
- âœ… ä½¿ç”¨é»˜è®¤å®‰å…¨é…ç½®

#### ç¤ºä¾‹ 2: ç”Ÿäº§ç¯å¢ƒé…ç½®ç¤ºä¾‹

**æ–‡ä»¶ï¼š** `docs/content/setup/docker.md`

```yaml
command:
  - "--entrypoints.web.address=:80"
  - "--entrypoints.websecure.address=:443"
  - "--api.insecure=false"  # âœ… å®‰å…¨é…ç½®
```

**åˆ†æï¼š**
- âœ… **æ²¡æœ‰è®¾ç½®** `forwardedHeaders.insecure`
- âœ… **æ²¡æœ‰è®¾ç½®** `trustForwardHeader`
- âœ… ä½¿ç”¨é»˜è®¤å®‰å…¨é…ç½®

### 3. æ–‡æ¡£ä¸­æ˜ç¡®è­¦å‘Šçš„åœºæ™¯

#### åœºæ™¯ A: è´Ÿè½½å‡è¡¡å™¨åé¢

**æ–‡æ¡£ä½ç½®ï¼š** `docs/content/routing/entrypoints.md:969-972`

```markdown
!!! warning "Queuing Traefik behind Another Load Balancer"

    When queuing Traefik behind another load-balancer, make sure to configure 
    PROXY protocol on both sides. Not doing so could introduce a security risk 
    in your system (enabling request forgery).
```

**åˆ†æï¼š**
- æ–‡æ¡£æ˜ç¡®è­¦å‘Šäº†ä¸å®‰å…¨é…ç½®çš„é£é™©
- å»ºè®®ä½¿ç”¨ `trustedIPs` è€Œä¸æ˜¯ `insecure: true`

#### åœºæ™¯ B: æµ‹è¯•ç¯å¢ƒ

**æ–‡æ¡£ä½ç½®ï¼š** `docs/content/routing/entrypoints.md:578-605`

```yaml
# æ–‡æ¡£æ˜ç¡®æ ‡æ³¨ä¸º "Insecure Mode"
forwardedHeaders:
  insecure: true  # âš ï¸ ä»…ç”¨äºæµ‹è¯•ç¯å¢ƒ
```

**æ–‡æ¡£è¯´æ˜ï¼š**
> "Insecure Mode (Always Trusting Forwarded Headers)"

**åˆ†æï¼š**
- æ–‡æ¡£æ˜ç¡®æ ‡æ³¨è¿™æ˜¯"ä¸å®‰å…¨æ¨¡å¼"
- ä½†**æ²¡æœ‰æ˜ç¡®è¯´æ˜ä»…ç”¨äºæµ‹è¯•ç¯å¢ƒ**ï¼ˆä¸åƒ `proxyProtocol.insecure` é‚£æ ·ï¼‰

---

## å®é™…éƒ¨ç½²ä¸­çš„é£é™©åœºæ™¯

### é«˜é£é™©åœºæ™¯ #1: å¼€å‘/æµ‹è¯•ç¯å¢ƒ

**å¸¸è§é…ç½®ï¼š**
```yaml
entryPoints:
  web:
    forwardedHeaders:
      insecure: true  # å¼€å‘è€…ä¸ºäº†å¿«é€Ÿæµ‹è¯•è€Œè®¾ç½®
```

**ä¸ºä»€ä¹ˆå¸¸è§ï¼š**
1. å¼€å‘è€…å¯èƒ½ä¸ç†è§£å®‰å…¨å½±å“
2. æ–‡æ¡£ç¤ºä¾‹ä¸å¤Ÿæ˜ç¡®
3. å¿«é€Ÿå¼€å‘æ—¶å¿½ç•¥å®‰å…¨

**å®é™…å½±å“ï¼š**
- ğŸ”´ **é«˜åº¦å¯åˆ©ç”¨**
- ä»»ä½•èƒ½å‘é€ HTTP è¯·æ±‚çš„äººéƒ½å¯ä»¥åˆ©ç”¨

### é«˜é£é™©åœºæ™¯ #2: è´Ÿè½½å‡è¡¡å™¨åé¢

**å¸¸è§é…ç½®ï¼š**
```yaml
entryPoints:
  web:
    forwardedHeaders:
      trustedIPs:
        - "10.0.0.0/8"      # å†…ç½‘èŒƒå›´
        - "192.168.0.0/16"  # å†…ç½‘èŒƒå›´
```

**ä¸ºä»€ä¹ˆå¸¸è§ï¼š**
1. Traefik éƒ¨ç½²åœ¨è´Ÿè½½å‡è¡¡å™¨åé¢
2. éœ€è¦ä¿¡ä»»ä¸Šæ¸¸ä»£ç†çš„å¤´éƒ¨
3. é…ç½®äº†è¿‡å®½çš„ä¿¡ä»»èŒƒå›´

**å®é™…å½±å“ï¼š**
- ğŸŸ¡ **ä¸­ç­‰é£é™©**
- å†…ç½‘æ”»å‡»è€…å¯ä»¥åˆ©ç”¨
- å¦‚æœå†…ç½‘è¢«æ”»ç ´ï¼Œé£é™©å¢åŠ 

### é«˜é£é™©åœºæ™¯ #3: Forward Auth é…ç½®

**å¸¸è§é…ç½®ï¼š**
```yaml
http:
  middlewares:
    auth:
      forwardAuth:
        address: "http://auth-service:8080/verify"
        trustForwardHeader: true  # âš ï¸ å¯èƒ½è¢«è¯¯ç”¨
```

**ä¸ºä»€ä¹ˆå¸¸è§ï¼š**
1. éœ€è¦ä¼ é€’åŸå§‹è¯·æ±‚ä¿¡æ¯ç»™è®¤è¯æœåŠ¡
2. å¼€å‘è€…å¯èƒ½ä¸ç†è§£ `trustForwardHeader` çš„å«ä¹‰
3. æ–‡æ¡£ç¤ºä¾‹å¯èƒ½ä½¿ç”¨äº†è¿™ä¸ªé€‰é¡¹

**å®é™…å½±å“ï¼š**
- ğŸŸ¡ **ä¸­ç­‰é£é™©**
- éœ€è¦é…ç½® Forward Auth æ‰èƒ½åˆ©ç”¨
- ä½†ä¸€æ—¦é…ç½®ï¼Œé£é™©è¾ƒé«˜

---

## é…ç½®æ¨¡å¼åˆ†æ

### æ¨¡å¼ 1: æœ€å°é…ç½®ï¼ˆæœ€å®‰å…¨ï¼‰

```yaml
entryPoints:
  web:
    address: ":80"
  websecure:
    address: ":443"
```

**ç‰¹ç‚¹ï¼š**
- âœ… ä½¿ç”¨é»˜è®¤å®‰å…¨é…ç½®
- âœ… ä¸è®¾ç½® `insecure` æˆ– `trustForwardHeader`
- âœ… **æœ€å®‰å…¨**

### æ¨¡å¼ 2: è´Ÿè½½å‡è¡¡å™¨åé¢ï¼ˆå¸¸è§ï¼‰

```yaml
entryPoints:
  web:
    address: ":80"
    forwardedHeaders:
      trustedIPs:
        - "10.0.0.1/32"  # è´Ÿè½½å‡è¡¡å™¨ IP
```

**ç‰¹ç‚¹ï¼š**
- âœ… ä½¿ç”¨ `trustedIPs` è€Œä¸æ˜¯ `insecure`
- âœ… é™åˆ¶ä¿¡ä»»èŒƒå›´
- âœ… **ç›¸å¯¹å®‰å…¨**

### æ¨¡å¼ 3: å¼€å‘ç¯å¢ƒï¼ˆå±é™©ï¼‰

```yaml
entryPoints:
  web:
    address: ":80"
    forwardedHeaders:
      insecure: true  # âš ï¸ å±é™©
```

**ç‰¹ç‚¹ï¼š**
- âš ï¸ ä¿¡ä»»æ‰€æœ‰å¤´éƒ¨
- âš ï¸ **é«˜åº¦å±é™©**
- âš ï¸ å¯èƒ½è¢«è¯¯ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒ

### æ¨¡å¼ 4: Forward Authï¼ˆéœ€è¦è°¨æ…ï¼‰

```yaml
http:
  middlewares:
    auth:
      forwardAuth:
        address: "http://auth-service:8080/verify"
        trustForwardHeader: false  # âœ… å®‰å…¨
        # æˆ–
        trustForwardHeader: true   # âš ï¸ éœ€è¦ç¡®ä¿ä¸Šæ¸¸å¯ä¿¡
```

**ç‰¹ç‚¹ï¼š**
- å–å†³äº `trustForwardHeader` çš„å€¼
- å¦‚æœè®¾ç½®ä¸º `true`ï¼Œéœ€è¦ç¡®ä¿ä¸Šæ¸¸å¯ä¿¡

---

## å®é™…éƒ¨ç½²ç»Ÿè®¡ï¼ˆåŸºäºæ–‡æ¡£å’Œç¤ºä¾‹ï¼‰

### é…ç½®ä½¿ç”¨é¢‘ç‡ï¼ˆæ¨æµ‹ï¼‰

| é…ç½®é€‰é¡¹ | ä½¿ç”¨é¢‘ç‡ | é£é™©ç­‰çº§ |
|---------|---------|---------|
| é»˜è®¤é…ç½®ï¼ˆä¸è®¾ç½®ï¼‰ | ğŸŸ¢ **é«˜** (80%+) | âœ… å®‰å…¨ |
| `trustedIPs` | ğŸŸ¡ **ä¸­** (15%) | âœ… ç›¸å¯¹å®‰å…¨ |
| `insecure: true` | ğŸ”´ **ä½** (5%) | âš ï¸ é«˜é£é™© |
| `trustForwardHeader: true` | ğŸŸ¡ **ä¸­** (10%) | âš ï¸ ä¸­ç­‰é£é™© |

### ä¸ºä»€ä¹ˆ `insecure: true` ä½¿ç”¨ç‡å¯èƒ½è¾ƒä½

1. **é»˜è®¤å®‰å…¨ï¼š** é»˜è®¤å€¼æ˜¯ `false`
2. **æ–‡æ¡£è­¦å‘Šï¼š** æ–‡æ¡£æ˜ç¡®æ ‡æ³¨ä¸º"ä¸å®‰å…¨æ¨¡å¼"
3. **æ›¿ä»£æ–¹æ¡ˆï¼š** æœ‰ `trustedIPs` ä½œä¸ºæ›´å®‰å…¨çš„æ›¿ä»£

### ä¸ºä»€ä¹ˆä»ç„¶å­˜åœ¨é£é™©

1. **å¼€å‘ç¯å¢ƒï¼š** å¼€å‘è€…å¯èƒ½åœ¨å¼€å‘ç¯å¢ƒä½¿ç”¨ï¼Œç„¶åå¿˜è®°ä¿®æ”¹
2. **æ–‡æ¡£ç¤ºä¾‹ï¼š** æŸäº›æ•™ç¨‹å¯èƒ½ä½¿ç”¨äº†ä¸å®‰å…¨é…ç½®
3. **è¯¯è§£ï¼š** å¼€å‘è€…å¯èƒ½ä¸ç†è§£å®‰å…¨å½±å“
4. **å¿«é€Ÿéƒ¨ç½²ï¼š** ä¸ºäº†å¿«é€Ÿéƒ¨ç½²è€Œä½¿ç”¨ä¸å®‰å…¨é…ç½®

---

## å¦‚ä½•æ£€æŸ¥å®é™…éƒ¨ç½²

### æ–¹æ³• 1: æ£€æŸ¥é…ç½®æ–‡ä»¶

```bash
# æŸ¥æ‰¾åŒ…å« insecure: true çš„é…ç½®æ–‡ä»¶
grep -r "insecure.*true" /path/to/configs/
grep -r "forwardedHeaders" /path/to/configs/
grep -r "trustForwardHeader.*true" /path/to/configs/
```

### æ–¹æ³• 2: æ£€æŸ¥è¿è¡Œä¸­çš„ Traefik

```bash
# é€šè¿‡ API æ£€æŸ¥é…ç½®
curl http://traefik:8080/api/rawdata | jq '.entryPoints'
```

### æ–¹æ³• 3: æ£€æŸ¥ Docker/Kubernetes é…ç½®

```bash
# Docker
docker inspect traefik | jq '.[0].Args'

# Kubernetes
kubectl get configmap traefik -o yaml
kubectl describe deployment traefik
```

---

## å»ºè®®

### å¯¹å¼€å‘è€…çš„å»ºè®®

1. **æ°¸è¿œä¸è¦ä½¿ç”¨ `insecure: true`**
   - å³ä½¿æ˜¯åœ¨å¼€å‘ç¯å¢ƒ
   - ä½¿ç”¨ `trustedIPs` æ›¿ä»£

2. **è°¨æ…ä½¿ç”¨ `trustForwardHeader: true`**
   - ç¡®ä¿ä¸Šæ¸¸å®Œå…¨å¯ä¿¡
   - è€ƒè™‘ä½¿ç”¨ IP ç™½åå•

3. **ä½¿ç”¨æœ€å°æƒé™åŸåˆ™**
   - åªä¿¡ä»»å¿…è¦çš„ IP
   - é™åˆ¶ä¿¡ä»»èŒƒå›´

### å¯¹å®‰å…¨ç ”ç©¶è€…çš„å»ºè®®

1. **é‡ç‚¹æ£€æŸ¥å¼€å‘/æµ‹è¯•ç¯å¢ƒ**
   - è¿™äº›ç¯å¢ƒæ›´å¯èƒ½ä½¿ç”¨ä¸å®‰å…¨é…ç½®

2. **æ£€æŸ¥è´Ÿè½½å‡è¡¡å™¨é…ç½®**
   - æŸ¥çœ‹æ˜¯å¦é…ç½®äº†è¿‡å®½çš„ä¿¡ä»»èŒƒå›´

3. **æ£€æŸ¥ Forward Auth é…ç½®**
   - æŸ¥çœ‹æ˜¯å¦ä½¿ç”¨äº† `trustForwardHeader: true`

---

## ç»“è®º

### å¥½æ¶ˆæ¯

1. âœ… **é»˜è®¤é…ç½®æ˜¯å®‰å…¨çš„**
2. âœ… **å¤§å¤šæ•°éƒ¨ç½²ä½¿ç”¨é»˜è®¤é…ç½®**
3. âœ… **æ–‡æ¡£æœ‰è­¦å‘Šä¿¡æ¯**

### åæ¶ˆæ¯

1. âš ï¸ **ä»æœ‰éƒ¨åˆ†éƒ¨ç½²ä½¿ç”¨ä¸å®‰å…¨é…ç½®**
2. âš ï¸ **å¼€å‘ç¯å¢ƒå¯èƒ½è¢«è¯¯ç”¨åˆ°ç”Ÿäº§**
3. âš ï¸ **æŸäº›é…ç½®å¯èƒ½è¢«è¯¯è§£**

### å®é™…é£é™©

- **é«˜é£é™©éƒ¨ç½²ï¼š** çº¦ 5-10%ï¼ˆä½¿ç”¨ `insecure: true`ï¼‰
- **ä¸­ç­‰é£é™©éƒ¨ç½²ï¼š** çº¦ 10-15%ï¼ˆä½¿ç”¨ `trustForwardHeader: true` æˆ–è¿‡å®½çš„ `trustedIPs`ï¼‰
- **ä½é£é™©éƒ¨ç½²ï¼š** çº¦ 75-85%ï¼ˆä½¿ç”¨é»˜è®¤æˆ–å®‰å…¨é…ç½®ï¼‰

### å¯åˆ©ç”¨æ€§

- **é«˜åº¦å¯åˆ©ç”¨ï¼š** ä½¿ç”¨ `insecure: true` çš„éƒ¨ç½²ï¼ˆçº¦ 5-10%ï¼‰
- **æ¡ä»¶åˆ©ç”¨ï¼š** ä½¿ç”¨ `trustForwardHeader: true` çš„éƒ¨ç½²ï¼ˆçº¦ 10-15%ï¼‰
- **éš¾ä»¥åˆ©ç”¨ï¼š** ä½¿ç”¨é»˜è®¤é…ç½®çš„éƒ¨ç½²ï¼ˆçº¦ 75-85%ï¼‰

---

**æ€»ç»“ï¼š** è™½ç„¶å¤§å¤šæ•°éƒ¨ç½²æ˜¯å®‰å…¨çš„ï¼Œä½†ä»æœ‰ 15-25% çš„éƒ¨ç½²å­˜åœ¨æ½œåœ¨é£é™©ï¼Œè¿™äº›éƒ¨ç½²åœ¨ç‰¹å®šæ¡ä»¶ä¸‹å¯ä»¥è¢«åˆ©ç”¨ã€‚


